"Change Set:		8438MonticelloConfigurations-ul.67MonticelloConfigurations-ul.67:- replace sends of #ifNotNilDo: to #ifNotNil:, #ifNil:ifNotNilDo: to #ifNil:ifNotNil:, #ifNotNilDo:ifNil: to #ifNotNil:ifNil:MonticelloConfigurations-ul.65:- enh: make sure that different images in the same directory can update simultaneously by adding the image name to the log file nameMonticelloConfigurations-bf.66:- return current configuration in updateFromRepositories"!!MCConfigurationBrowser methodsFor: 'description' stamp: 'ul 12/12/2009 14:10'!description: aText	self selectedRepository ifNotNil: [:repo | 		| new | 		new := MCRepository readFrom: aText asString.		(new class = repo class 			and: [new description = repo description])				ifTrue: [					repo creationTemplate: aText asString.					self changed: #description]				ifFalse: [					self inform: 'This does not match the previous definition!!'				]	].! !!MCConfigurationBrowser methodsFor: 'description' stamp: 'ul 12/12/2009 14:10'!description	self selectedDependency ifNotNil: [:dep | ^ ('Package: ', dep package name, String cr,		dep versionInfo summary) asText].	self selectedRepository ifNotNil: [:repo | ^repo creationTemplate		ifNotNil: [repo creationTemplate asText]		ifNil: [repo asCreationTemplate asText addAttribute: TextColor red]].	^ ''! !!MCConfigurationBrowser methodsFor: 'actions' stamp: 'ul 12/12/2009 14:10'!store	(self checkRepositories and: [self checkDependencies]) ifFalse: [^self].	self pickName ifNotNil: [:name |		self configuration name: name.		self pickRepository ifNotNil: [:repo |			repo storeVersion: self configuration]].! !!MCConfiguration methodsFor: 'accessing' stamp: 'ul 12/10/2009 11:47'!log	"Answer the receiver's log. If no log exist use the default log"		^log ifNil: [		(name notNil and: [ self class logToFile ]) ifFalse: [ ^Transcript ].		self log: (FileStream fileNamed: self logFileName).		log ]! !!MCConfigurationBrowser methodsFor: 'dependencies' stamp: 'ul 12/12/2009 14:10'!selectedPackage	^ self selectedDependency ifNotNil: [:dep | dep package]! !!MCConfiguration methodsFor: 'accessing' stamp: 'ul 12/10/2009 11:56'!logFileName	^self name, '-', (FileDirectory localNameFor: SmalltalkImage current imageName), '.log'	! !!MCMcmUpdater class methodsFor: 'updating' stamp: 'bf 12/11/2009 12:16'!updateFromRepositories: repositoryUrls	"MCMcmUpdater updateFromRepositories: #(		'http://squeaksource.com/MCUpdateTest'	)"	| repos updateList parts base author version type config minVersion |	Preferences enable: #upgradeIsMerge.	LastUpdateMap ifNil:[LastUpdateMap := Dictionary new].	"The list of repositories to consult in order"	repos := repositoryUrls collect:[:url| 		MCRepositoryGroup default repositories 			detect:[:r| r description = url]			ifNone:[ | r |				r := MCHttpRepository location: url user: '' password: ''.				MCRepositoryGroup default addRepository: r.				r]].	"The list of updates-author.version.mcm sorted by version"	repos do:[:r|		updateList := SortedCollection new.		minVersion := LastUpdateMap at: r description ifAbsent:[0].		"Find all the updates-author.version.mcm files"		r allFileNames do:[:versionedName|			parts := versionedName findTokens: '.-'.			parts size = 4 ifTrue:[				base := parts at: 1.				author := parts at: 2.				version := [(parts at: 3) asNumber] on: Error do:[:ex| ex return: 0].				type := parts at: 4.			].			(base = 'update' and:[version >= minVersion and:[type = 'mcm']]) 				ifTrue:[updateList add: version -> versionedName]].				"Proceed only if there are updates available at all."		updateList ifNotEmpty: [			"Now process each update file. Check if we have all dependencies and if not,			load the entire configuration (this is mostly to skip older updates quickly)"			updateList do:[:assoc|				ProgressNotification signal: '' extra: 'Processing ', assoc value.				config := r versionFromFileNamed: assoc value.				(config dependencies allSatisfy:[:dep| dep isFulfilled]) 					ifFalse:[config upgrade].				LastUpdateMap at: r description put: assoc key.			] displayingProgress: 'Processing configurations'.			"We've loaded all the provided update configurations.			Use the latest configuration to update all the remaining packages."			config updateFromRepositories.			config upgrade.		].	].	^config! !!MCConfigurationBrowser methodsFor: 'repositories' stamp: 'ul 12/12/2009 14:10'!addRepository	(self pickRepositorySatisfying: [:ea | (self repositories includes: ea) not])		ifNotNil: [:repo |			(repo isKindOf: MCHttpRepository)				ifFalse: [^self inform: 'Only HTTP repositories are supported'].			self repositories add: repo.			self changed: #repositoryList.		]! !