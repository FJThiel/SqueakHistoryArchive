"Change Set:		8516Kernel-ar.333Kernel-ar.333:CompiledMethodTrailer phase 2."!!CompiledMethod class methodsFor: 'instance creation' stamp: 'Igor.Stasenko 12/20/2009 04:40'!newBytes: numberOfBytes trailerBytes: trailer nArgs: nArgs nTemps: nTemps nStack: stackSize nLits: nLits primitive: primitiveIndex flag: flag	"Answer an instance of me. The header is specified by the message 	arguments. The remaining parts are not as yet determined."	| largeBit primBits flagBit |	nTemps > 63 ifTrue:		[^ self error: 'Cannot compile -- too many temporary variables'].		nLits > 255 ifTrue:		[^ self error: 'Cannot compile -- too many literals variables'].		largeBit := (nTemps + stackSize) > SmallFrame ifTrue: [1] ifFalse: [0].	"For now the high bit of the primitive no. is in a high bit of the header"	primBits := (primitiveIndex bitAnd: 16r1FF) + ((primitiveIndex bitAnd: 16r200) bitShift: 19).	flagBit := flag ifTrue: [ 1 ] ifFalse: [ 0 ].	"Copy the source code trailer to the end"	^ trailer createMethod: numberOfBytes		header: (nArgs bitShift: 24) +				(nTemps bitShift: 18) +				(largeBit bitShift: 17) +				(nLits bitShift: 9) +				primBits +				(flagBit bitShift: 29).! !!CompiledMethod methodsFor: 'source code management' stamp: 'Igor.Stasenko 12/20/2009 07:33'!copyWithTempNames: tempNames	"Minimal temp name copy that only works for methods containing no temporaries or blocks with arguments.	Used by the Traits system for creating conflict and required methdos that generate warnings.	For generic use use copyWithTempsFromMethodNode:"	| tempString |	tempString := String streamContents:					[:str|					tempNames						do: [:temp| str nextPutAll: temp]						separatedBy: [str space].					str space].	^self copyWithTrailerBytes: (CompiledMethodTrailer new tempNames: tempString)				! !!CompiledMethod class methodsFor: 'instance creation' stamp: 'Igor.Stasenko 12/20/2009 04:32'!toReturnSelf	"Answer an instance of me that is a quick return of the instance (^self)."	^ self toReturnSelfTrailerBytes: CompiledMethodTrailer empty! !!CompiledMethod methodsFor: 'initialize-release' stamp: 'Igor.Stasenko 12/20/2009 05:17'!copyWithTrailerBytes: trailer"Testing:	(CompiledMethod compiledMethodAt: #copyWithTrailerBytes:)		tempNamesPut: 'copy end '"	| copy end start |	start := self initialPC.	end := self endPC.	copy := trailer createMethod: end - start + 1 header: self header.	1 to: self numLiterals do: [:i | copy literalAt: i put: (self literalAt: i)].	start to: end do: [:i | copy at: i put: (self at: i)].	^ copy! !!CompiledMethod methodsFor: 'source code management' stamp: 'Igor.Stasenko 12/20/2009 07:31'!copyWithTempsFromMethodNode: aMethodNode	^self copyWithTrailerBytes: (		CompiledMethodTrailer new tempNames: aMethodNode schematicTempNamesString)! !!CompiledMethod class methodsFor: 'instance creation' stamp: 'Igor.Stasenko 12/20/2009 05:21'!newBytes: numberOfBytes trailerBytes: trailer nArgs: nArgs nTemps: nTemps nStack: stackSize nLits: nLits primitive: primitiveIndex	"Answer an instance of me. The header is specified by the message 	arguments. The remaining parts are not as yet determined."	| largeBit primBits |	nTemps > 63 ifTrue:		[^ self error: 'Cannot compile -- too many temporary variables'].		nLits > 255 ifTrue:		[^ self error: 'Cannot compile -- too many literals variables'].		largeBit := (nTemps + stackSize) > SmallFrame ifTrue: [1] ifFalse: [0].	primBits := primitiveIndex <= 16r1FF		ifTrue: [primitiveIndex]		ifFalse: ["For now the high bit of primitive no. is in the 29th bit of header"				primitiveIndex > 16r3FF ifTrue: [self error: 'prim num too large'].				(primitiveIndex bitAnd: 16r1FF) + ((primitiveIndex bitAnd: 16r200) bitShift: 19)].	^ trailer createMethod: numberOfBytes		 header: (nArgs bitShift: 24) +				(nTemps bitShift: 18) +				(largeBit bitShift: 17) +				(nLits bitShift: 9) +				primBits.! !