'From Squeak3.7beta of ''1 April 2004'' [latest update: #5969] on 6 July 2004 at 12:56:26 am'!"Change Set:		SpaceTally-cleanUp-efcDate:			6 July 2004Author:			Eddie Cottongim1. Avoid sending #instanceCount twice for each class, achieving a roughly 50% speedup. see #computeSpaceUsage.2. Factor out the common code between SpaceTally's #spaceTally and #systemWideSpaceTally methods.3. Fix the incorrect example in #systemWideSpaceTally.The following code:  Time millisecondsToRun: [st _ SpaceTally new systemWideSpaceTally ]exibited this performance change:factored: 95.071 secondsoriginal: 198.560 seconds"!!SpaceTally methodsFor: 'instance size' stamp: 'efc 7/6/2004 00:30'!spaceForInstancesOf: aClass withInstanceCount: instCount	"Answer the number of bytes consumed by all instances of the given class, including their object headers."	| isCompact instVarBytes bytesPerElement contentBytes headerBytes total |	instCount = 0 ifTrue: [^ 0].	isCompact _ aClass indexIfCompact > 0.	instVarBytes _ aClass instSize * 4.	aClass isVariable		ifTrue: [			bytesPerElement _ aClass isBytes ifTrue: [1] ifFalse: [4].			total _ 0.			aClass allInstancesDo: [:inst |				contentBytes _ instVarBytes + (inst size * bytesPerElement).				headerBytes _					contentBytes > 255						ifTrue: [12]						ifFalse: [isCompact ifTrue: [4] ifFalse: [8]].				total _ total + headerBytes + contentBytes].			^ total]		ifFalse: [			headerBytes _				instVarBytes > 255					ifTrue: [12]					ifFalse: [isCompact ifTrue: [4] ifFalse: [8]].			^ instCount * (headerBytes + instVarBytes)].! !!SpaceTally methodsFor: 'class analysis' stamp: 'efc 7/6/2004 00:30'!computeSpaceUsage	| entry c instanceCount |	1 to: results size do: [:i |		entry := results at: i.		c := self class environment at: entry analyzedClassName.		instanceCount _ c instanceCount.		entry codeSize: c spaceUsed.		entry instanceCount: instanceCount.		entry spaceForInstances: (self spaceForInstancesOf: c withInstanceCount: instanceCount).		Smalltalk garbageCollectMost].	! !!SpaceTally methodsFor: 'class analysis' stamp: 'efc 7/6/2004 00:25'!systemWideSpaceTally	"Answer a collection of SpaceTallyItems representing the memory space (in bytes) consumed 	by the code and instances of each class in the system. Note that code sizes do not currently 	report memory consumed by class variables. "	"(SpaceTally new systemWideSpaceTally asSortedCollection: [:a :b | a spaceForInstances > b spaceForInstances]) asArray"	^self spaceTally: Smalltalk allClasses.! !SpaceTally removeSelector: #spaceForInstancesOf:!