'From Squeak2.9alpha of 17 July 2000 [latest update: #2554] on 1 September 2000 at 10:58:37 am'!"Change Set:		nebraskaTransformDate:			1 September 2000Author:			Bob Arning- fixed Nebraska clipping test to include transformation so that rotated/scaled images will show"!!CanvasEncoder methodsFor: 'drawing' stamp: 'RAA 9/1/2000 09:08'!image: aForm at: aPoint sourceRect: sourceRect rule: rule	| cacheID cacheNew cacheReply formToSend cacheEntry destRect visRect aFormArea d2 |	"first if we are only going to be able to draw a small part of the form,	it may be faster just to send the part of the form that will actually show up"	destRect _ aPoint extent: sourceRect extent.	d2 _ (lastTransform invertBoundsRect: destRect) expandBy: 1.	(d2 intersects: lastClipRect) ifFalse: [		^NebraskaDebug at: #bigImageSkipped add: {lastClipRect. d2}.	].	aFormArea _ aForm boundingBox area.	(aFormArea > 20000 and: [aForm isStatic not and: [lastTransform isPureTranslation]]) ifTrue: [		visRect _ destRect intersect: lastClipRect.		visRect area < (aFormArea // 20) ifTrue: [			"NebraskaDebug 				at: #bigImageReduced 				add: {lastClipRect. aPoint. sourceRect extent. lastTransform}."			formToSend _ aForm copy: (visRect translateBy: sourceRect origin - aPoint).			^self 				image: formToSend 				at: visRect origin 				sourceRect: formToSend boundingBox				rule: rule				cacheID: 0 		"no point in trying to cache this - it's a one-timer"				newToCache: false.		].	].	cacheID _ 0.	cacheNew _ false.	formToSend _ aForm.	(aFormArea > 1000 and: [(cacheReply _ self testCache: aForm) notNil]) ifTrue: [		cacheID _ cacheReply first.		cacheEntry _ cacheReply third.		(cacheNew _ cacheReply second) ifFalse: [			formToSend _ aForm isStatic 				ifTrue: [nil] 				ifFalse: [aForm deltaFrom: cacheEntry fourth].		].		cacheEntry at: 4 put: (aForm isStatic ifTrue: [aForm] ifFalse: [aForm deepCopy]).	].	self		image: formToSend 		at: aPoint 		sourceRect: sourceRect 		rule: rule 		cacheID: cacheID 		newToCache: cacheNew.! !!CanvasEncoder methodsFor: 'drawing' stamp: 'RAA 9/1/2000 09:09'!image: aFormOrNil at: aPoint sourceRect: sourceRect rule: rule cacheID: cacheID newToCache: newToCache	| t destRect d2 |	destRect _ aPoint extent: sourceRect extent.	d2 _ (lastTransform invertBoundsRect: destRect) expandBy: 1.	(d2 intersects: lastClipRect) ifFalse: [		^NebraskaDebug at: #bigImageSkipped add: {lastClipRect. d2}.	].	t _ Time millisecondsToRun: [		self sendCommand: {			String with: CanvasEncoder codeImage.			self class encodeImage: aFormOrNil.			self class encodePoint: aPoint.			self class encodeRectangle: sourceRect.			self class encodeInteger: rule.			self class encodeInteger: cacheID.			self class encodeInteger: (newToCache ifTrue: [1] ifFalse: [0]).		}.	].	(aFormOrNil notNil and: [aFormOrNil boundingBox area > 100]) ifTrue: [		NebraskaDebug 			at: #bigImage 			add: {lastClipRect. aPoint. sourceRect extent. t. cacheID. newToCache}.	].! !