'From Squeak 2.3 of January 14, 1999 on 12 April 1999 at 4:47:10 pm'!"Change Set:		tabletFun-jhmDate:			12 April 1999Author:			John MaloneyAdds a number of fun tablet-based drawing examples to Pen class for experimenting with a Wacom or similar pen tablet on platforms that support the tablet primitives.Changes two WarpBlt methods in minor ways:  1. cellSize: doesn't warn you if you try to use a cell size greater than 3, and  2. warpBits lets sourceForm choose its own colormap; this allows ColorForms to be used."!!InputSensor methodsFor: 'tablet' stamp: 'jm 4/12/1999 13:05'!tabletPressure	"Answer the current pressure of the first tablet pointing device (pen, puck, or eraser), a number between 0.0 (no pressure) and 1.0 (max pressure)"	| params data |	params _ self primTabletGetParameters: 1.	params ifNil: [^ self].	data _ self primTabletRead: 1.  "state of first/primary pen"	^ (data at: 10) asFloat / ((params at: 10) - 1)! !!InputSensor methodsFor: 'private' stamp: 'jm 4/12/1999 13:04'!primTabletGetParameters: cursorIndex	"Answer the pen tablet parameters. For parameters that differ from cursor to cursor, answer those associated with the cursor having the given index. Answer nil if there is no pen tablet. The parameters are:	1. tablet width, in tablet units	2. tablet height, in tablet units	3. number of tablet units per inch	4. number of cursors (pens, pucks, etc; some tablets have more than one)	5. this cursor index	6. and 7. x scale and x offset for scaling tablet coordintes (e.g., to fit the screen)	8. and 9. y scale and y offset for scaling tablet coordintes  (e.g., to fit the screen)	10. number of pressure levels	11. presure threshold needed close pen tip switch 	12. number of pen tilt angles"	<primitive: 548>	^ nil! !!Pen class methodsFor: 'tablet drawing examples' stamp: 'jm 4/12/1999 16:40'!feltTip: width cellSize: cellSize	"Warning: This example potentially uses a large amount of memory--it creates a Form with cellSize squared bits for every Display pixel."	"In this example, all drawing is done into a large, monochrome Form and then scaled down onto the Display using smoothing. The larger the cell size, the more possible shades of gray can be generated, and the smoother the resulting line appears. A cell size of 8 yields 64 possible grays, while a cell size of 16 gives 256 levels, which is about the maximum number of grays that the human visual system can distinguish. The width parameter determines the maximum line thickness. Requires the optional tablet support primitives which may not be supported on all platforms. Works best in full screen mode. Shift-mouse to exit." 	"Pen feltTip: 2.7 cellSize: 8"	| bitForm pen warp p srcR dstR nibSize startP r |	bitForm _ Form extent: Display extent * cellSize depth: 1.	pen _ Pen newOnForm: bitForm.	pen color: Color black.	warp _ (WarpBlt toForm: Display)		sourceForm: bitForm;		colorMap: (bitForm colormapIfNeededForDepth: Display depth);		cellSize: cellSize;		combinationRule: Form over.	Display fillColor: Color white.	Display restoreAfter: [		[Sensor shiftPressed and: [Sensor anyButtonPressed]] whileFalse: [			p _ (Sensor tabletPoint * cellSize) // 8.			nibSize _ (Sensor tabletPressure * (cellSize * width)) rounded.		     nibSize > 0				ifTrue: [					pen squareNib: nibSize.					startP _ pen location.					pen goto: p.					r _ startP rect: pen location.					dstR _ (r origin // cellSize) corner: ((r corner + nibSize + (cellSize - 1)) // cellSize).					srcR _ (dstR origin * cellSize) corner: (dstR corner * cellSize).					warp copyQuad: srcR innerCorners toRect: dstR]				ifFalse: [					pen place: p]]].! !!Pen class methodsFor: 'tablet drawing examples' stamp: 'jm 4/12/1999 16:40'!inkBrush	"Similar to simplePressurePen, but this example uses the average of the recent pen pressure values. The effect is that of a Japanese ink brush that comes up gradually off the paper as the brush is lifted, causing end (and beginning) of each stroke to taper. Requires the optional tablet support primitives which may not be supported on all platforms. Works best in full screen mode. Shift-mouse to exit." 	"Pen inkBrush"	| historyMSecs pressureHistory pen now currentPressure sum averagePressure p |	historyMSecs _ 120.	pressureHistory _ OrderedCollection new.	pen _ Pen newOnForm: Display.	pen color: Color black.	Display fillColor: Color white.	Display restoreAfter: [		[Sensor shiftPressed and: [Sensor anyButtonPressed]] whileFalse: [			"compute the average pressure over last historyMSecs milliseconds"			now _ Time millisecondClockValue.			currentPressure _ (20.0 * Sensor tabletPressure) rounded.			pressureHistory addLast: (Array with: now with: currentPressure).			[pressureHistory size > 0 and:			 [(pressureHistory first first + historyMSecs) < now]]				whileTrue: [pressureHistory removeFirst].  "prune old entries"			sum _ pressureHistory inject: 0 into: [:t :e | t + e last].			averagePressure _ sum // pressureHistory size.			p _ Sensor tabletPoint // 8.		     averagePressure > 0				ifTrue: [					pen roundNib: averagePressure.					pen goto: p]				ifFalse: [					pen place: p]]].! !!Pen class methodsFor: 'tablet drawing examples' stamp: 'jm 4/12/1999 16:39'!simplePressurePen	"An example of using a pressure sensitive pen to control the thickness of the pen. This requires the optional tablet support primitives which may not be supported on all platforms. Works best in full screen mode. Shift-mouse to exit." 	"Pen simplePressurePen"	| pen pressure p |	pen _ Pen newOnForm: Display.	pen color: Color black.	Display fillColor: Color white.	Display restoreAfter: [		[Sensor shiftPressed and: [Sensor anyButtonPressed]] whileFalse: [			p _ Sensor tabletPoint // 8.			pressure _ (15.0 * Sensor tabletPressure) rounded.		     pressure > 0				ifTrue: [					pen roundNib: pressure.					pen goto: p]				ifFalse: [					pen place: p]]].! !!Pen class methodsFor: 'tablet drawing examples' stamp: 'jm 4/12/1999 12:51'!testMouseTracking	"A very simple example of drawing using the mouse. Compare the tracking speed of this example with that of testTabletTracking. Mouse down to draw a stroke, shift-mouse to exit." 	"Pen testMouseTracking"	| pen p |	pen _ Pen newOnForm: Display.	pen roundNib: 8.	pen color: Color black.	Display fillColor: Color white.	Display restoreAfter: [		[Sensor shiftPressed and: [Sensor anyButtonPressed]] whileFalse: [			p _ Sensor cursorPoint.		     Sensor anyButtonPressed				ifTrue: [pen goto: p]				ifFalse: [					pen color: Color random.					pen place: p]]].! !!Pen class methodsFor: 'tablet drawing examples' stamp: 'jm 4/12/1999 16:38'!testTabletTracking	"A very simple example of drawing using the pen of a digitizing tablet such as a Wacom ArtZ tablet. This requires the optional tablet support primitives which may not be supported on all platforms. Compare the tracking speed of this example with that of testMouseTracking. On a Macintosh, the tablet primitives provide roughly 120 samples/second versus only 60 mouse samples/second, and the difference is noticable. Works best in full screen mode. Mouse down to draw a stroke, shift-mouse to exit." 	"Pen testTabletTracking"	| pen p |	pen _ Pen newOnForm: Display.	pen roundNib: 8.	pen color: Color black.	Display fillColor: Color white.	Display restoreAfter: [		[Sensor shiftPressed and: [Sensor anyButtonPressed]] whileFalse: [			p _ Sensor tabletPoint // 8.		     Sensor tabletPressure > 0				ifTrue: [pen goto: p]				ifFalse: [					pen color: Color random.					pen place: p]]].! !!WarpBlt methodsFor: 'setup' stamp: 'jm 4/11/1999 12:00'!cellSize: s	cellSize _ s.	cellSize = 1 ifTrue: [^ self].	colorMap _ Color colorMapIfNeededFrom: 32 to: destForm depth.! !!WarpBlt methodsFor: 'primitives' stamp: 'jm 4/11/1999 13:45'!warpBits	"Move those pixels!!"	self warpBitsSmoothing: cellSize		sourceMap: (sourceForm colormapIfNeededForDepth: 32).! !