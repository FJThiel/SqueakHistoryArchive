'From Squeak3.6beta of ''4 July 2003'' [latest update: #5387] on 17 August 2003 at 12:57:35 am'!"Change Set:		FormReadWriteFix2Date:			17 August 2003Author:			Masashi UmezawaRefactored version of original FormReadWriteFix(13 August 2003).No code duplications."!!Form methodsFor: 'fileIn/Out' stamp: 'mu 8/17/2003 00:44'!readAttributesFrom: aBinaryStream	| offsetX offsetY |	depth _ aBinaryStream next.	(self depth isPowerOfTwo and: [self depth between: 1 and: 32])		ifFalse: [self error: 'invalid depth; bad Form file?'].	width _ aBinaryStream nextWord.	height _ aBinaryStream nextWord.	offsetX  _ aBinaryStream nextWord.	offsetY _ aBinaryStream nextWord.	offsetX > 32767 ifTrue: [offsetX _ offsetX - 65536].	offsetY > 32767 ifTrue: [offsetY _ offsetY - 65536].	offset _ Point x: offsetX y: offsetY.	! !!Form methodsFor: 'fileIn/Out' stamp: 'mu 8/17/2003 00:43'!readBitsFrom: aBinaryStream		bits _ Bitmap newFromStream: aBinaryStream.	bits size = self bitsSize ifFalse: [self error: 'wrong bitmap size; bad Form file?'].	^ self! !!Form methodsFor: 'fileIn/Out' stamp: 'mu 8/17/2003 00:44'!readFrom: aBinaryStream	"Reads the receiver from the given binary stream with the format:		depth, extent, offset, bits."	self readAttributesFrom: aBinaryStream.	self readBitsFrom: aBinaryStream! !!Form methodsFor: 'fileIn/Out' stamp: 'mu 8/17/2003 00:35'!writeAttributesOn: file	self unhibernate.	file nextPut: depth.	file nextWordPut: width.	file nextWordPut: height.	file nextWordPut: ((self offset x) >=0					ifTrue: [self offset x]					ifFalse: [self offset x + 65536]).	file nextWordPut: ((self offset y) >=0					ifTrue: [self offset y]					ifFalse: [self offset y + 65536]).	! !!Form methodsFor: 'fileIn/Out' stamp: 'mu 8/17/2003 00:35'!writeBitsOn: file	bits writeOn: file! !!Form methodsFor: 'fileIn/Out' stamp: 'mu 8/17/2003 00:36'!writeOn: file	"Write the receiver on the file in the format		depth, extent, offset, bits."	self writeAttributesOn: file.	self writeBitsOn: file! !!ColorForm methodsFor: 'fileIn/Out' stamp: 'mu 8/17/2003 00:46'!readAttributesFrom: aBinaryStream	super readAttributesFrom: aBinaryStream.	colors _ ColorArray new: (2 raisedTo: depth).	1 to: colors size do: [:idx | 		colors basicAt: idx put: (aBinaryStream nextLittleEndianNumber: 4).	]. 	! !!ColorForm methodsFor: 'fileIn/Out' stamp: 'mu 8/17/2003 00:42'!writeAttributesOn: file	| colorArray |	super writeAttributesOn: file.	colorArray _ self colors asColorArray.	1 to: (2 raisedTo: depth) do: [:idx |		file nextLittleEndianNumber: 4 put: (colorArray basicAt: idx).	] ! !