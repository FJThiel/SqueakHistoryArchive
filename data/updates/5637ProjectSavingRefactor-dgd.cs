'From Squeak3.5 of ''11 April 2003'' [latest update: #5180] on 23 December 2003 at 4:38:21 pm'!"Change Set:		ProjectSavingRefactor-dgdDate:			23 December 2003Author:			Diego Gomez Deck <DiegoGomezDeck@ConsultAr.com>Small refactoring:When a project is going to be saved it asks the destination (normally a ServerDirectory) for the way to do that.In this way different implementation of ServerDirectory can use different ways to store the project than the sequence #upLoadProject:named:resourceUrl:retry: #deleteFileNamed:ifAbsent: #putFile:named:retry: #updateProjectInfoFor: and #sleep in Project>>writeFileNamed:fromDirectory:toServer:This change is full compatible with the current implementations of ServerDirectory but it's needed for future work on superswikis-like project repositories.  (One new project repository is coming from the folks from Small-Land ;))"!!FileDirectory methodsFor: 'squeaklets' stamp: 'dgd 12/23/2003 16:21'!writeProject: aProject inFileNamed: fileNameString fromDirectory: localDirectory 	"write aProject (a file version can be found in the file named fileNameString in localDirectory)"	aProject		writeFileNamed: fileNameString		fromDirectory: localDirectory		toServer: self! !!Project methodsFor: 'file in/out' stamp: 'dgd 12/23/2003 16:24'!storeOnServerInnards	"Save to disk as an Export Segment.  Then put that file on the server I came from, as a new version.  Version is literal piece of file name.  Mime encoded and http encoded."	| resp newName primaryServerDirectory serverVersionPair localDirectory localVersionPair myVersionNumber warning maxNumber suppliedPassword oldResourceUrl |	self assureIntegerVersion.	"Find out what version"	primaryServerDirectory _ self primaryServerIfNil: [		(primaryServerDirectory _ self findAFolderToStoreProjectIn) ifNil: [^self].		oldResourceUrl _ self resourceUrl.		primaryServerDirectory == #localOnly ifTrue: [			self storeNewPrimaryURL: (FileUrl absoluteFromText: FileDirectory default pathName) downloadUrl.			nil		] ifFalse: [			self storeNewPrimaryURL: primaryServerDirectory downloadUrl.			primaryServerDirectory		].	].	localDirectory _ self squeakletDirectory.	serverVersionPair _ self class mostRecent: self name onServer: primaryServerDirectory.	localVersionPair _ self class mostRecent: self name onServer: localDirectory.	maxNumber _ myVersionNumber _ self currentVersionNumber.	ProgressNotification signal: '2:versionsDetected'.	warning _ ''.	myVersionNumber < serverVersionPair second ifTrue: [		warning _ warning,'\There are newer version(s) on the server'.		maxNumber _ maxNumber max: serverVersionPair second.	].	myVersionNumber < localVersionPair second ifTrue: [		warning _ warning,'\There are newer version(s) in the local directory'.		maxNumber _ maxNumber max: localVersionPair second.	].	"8 Nov 2000 - only check on the first attempt to publish"	myVersionNumber = 0 ifTrue: [		warning isEmpty ifFalse: [			myVersionNumber = 0 ifTrue: [				warning _ warning,'\THIS PROJECT HAS NEVER BEEN SAVED'			].			warning _ 'WARNING', '\Project: ',self name,warning.			resp _ (PopUpMenu labels: 'Store anyway\Cancel' withCRs) startUpWithCaption: 				(warning, '\Please cancel, rename this project, and see what is there.') withCRs.				resp ~= 1 ifTrue: [^ nil]		].	].	version _ self bumpVersion: maxNumber.	oldResourceUrl		ifNotNil: [self resourceManager adjustToNewServer: self resourceUrl from: oldResourceUrl].	"write locally - now zipped automatically"	newName _ self versionedFileName.	lastSavedAtSeconds _ Time totalSeconds.	self exportSegmentFileName: newName directory: localDirectory.	(localDirectory readOnlyFileNamed: newName) setFileTypeToObject; close.	ProgressNotification signal: '4:localSaveComplete'.	"3 is deep in export logic"	primaryServerDirectory ifNotNil: [		suppliedPassword _ ''.		Preferences passwordsOnPublish ifTrue: [			suppliedPassword _ FillInTheBlank requestPassword: 'Project password'		].		[		primaryServerDirectory			writeProject: self			inFileNamed: newName			fromDirectory: localDirectory.		] on: ProjectPasswordNotification do: [ :ex |			ex resume: (suppliedPassword ifNil: [''])		].	].	ProgressNotification signal: '9999 save complete'.	"Later, store with same name on secondary servers.  Still can be race conditions.  All machines will go through the server list in the same order."	"2 to: servers size do: [:aServer | aServer putFile: local named: newName]."! !!ServerDirectory methodsFor: 'squeaklets' stamp: 'dgd 12/23/2003 16:21'!writeProject: aProject inFileNamed: fileNameString fromDirectory: localDirectory 	"write aProject (a file version can be found in the file named fileNameString in localDirectory)"	aProject		writeFileNamed: fileNameString		fromDirectory: localDirectory		toServer: self! !