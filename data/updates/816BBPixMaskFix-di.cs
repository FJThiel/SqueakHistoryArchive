'From Squeak 2.3 of January 14, 1999 on 11 April 1999 at 8:29:19 am'!"Change Set:		BBPixMaskFixDate:			10 April 1999Author:			Dan IngallsFixes a bug in BitBlt that caused inaccurate tallies and possible crashes when running tallyPixels in 16 bits with a 32k color table.Reported independently by Andres Valloud and John Malone."!!BitBltSimulation methodsFor: 'pixel mapping' stamp: 'di 4/10/1999 17:27'!rgbMap: sourcePixel from: nBitsIn to: nBitsOut	"Convert the given pixel value with nBitsIn bits for each color component to a pixel value with nBitsOut bits for each color component. Typical values for nBitsIn/nBitsOut are 3, 5, or 8."	| mask d srcPix destPix |	self inline: true.	(d _ nBitsOut - nBitsIn) > 0		ifTrue:			["Expand to more bits by zero-fill"			mask _ (1 << nBitsIn) - 1.  "Transfer mask"			srcPix _ sourcePixel << d.			mask _ mask << d.			destPix _ srcPix bitAnd: mask.			mask _ mask << nBitsOut.			srcPix _ srcPix << d.			^ destPix + (srcPix bitAnd: mask)				 	+ (srcPix << d bitAnd: mask << nBitsOut)]		ifFalse:			["Compress to fewer bits by truncation"			d = 0 ifTrue:				[nBitsIn = 5 ifTrue:					["Sometimes called with 16 bits, though pixel is 15,					but we must never return more than 15."					^ sourcePixel bitAnd: 16r7FFF].				nBitsIn = 8 ifTrue:					["Sometimes called with 32 bits, though pixel is 24,					but we must never return more than 24."					^ sourcePixel bitAnd: 16rFFFFFF].				^ sourcePixel].  "no compression"			sourcePixel = 0 ifTrue: [^ sourcePixel].  "always map 0 (transparent) to 0"			d _ nBitsIn - nBitsOut.			mask _ (1 << nBitsOut) - 1.  "Transfer mask"			srcPix _ sourcePixel >> d.			destPix _ srcPix bitAnd: mask.			mask _ mask << nBitsOut.			srcPix _ srcPix >> d.			destPix _ destPix + (srcPix bitAnd: mask)					+ (srcPix >> d bitAnd: mask << nBitsOut).			destPix = 0 ifTrue: [^ 1].  "Dont fall into transparent by truncation"			^ destPix]! !