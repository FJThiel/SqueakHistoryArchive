'From Squeakland 3.2.4913 of 10 July 2002 [latest update: #198] on 11 March 2004 at 10:04:38 am'!"Change Set:		loadProjectFixDate:			9 March 2004Author:			Michael RuegerFixes a problem with loading projects through the world menu."!!ComplexProgressIndicator methodsFor: 'as yet unclassified' stamp: 'mir 3/9/2004 16:27'!withProgressDo: aBlock	| safetyFactor totals trialRect delta stageCompletedString targetOwner |	Smalltalk isMorphic ifFalse: [^aBlock value].	formerProject _ Project current.	formerWorld _ World.	formerProcess _ Processor activeProcess.	targetMorph		ifNil: [targetMorph _ ProgressTargetRequestNotification signal].	targetMorph ifNil: [		trialRect _ Rectangle center: Sensor cursorPoint extent: 80@80.		delta _ trialRect amountToTranslateWithin: formerWorld bounds.		trialRect _ trialRect translateBy: delta.		translucentMorph _ TranslucentProgessMorph new			opaqueBackgroundColor: Color white;			bounds: trialRect;			openInWorld: formerWorld.	] ifNotNil: [		targetOwner := targetMorph owner.		translucentMorph _ TranslucentProgessMorph new			setProperty: #morphicLayerNumber toValue: targetMorph morphicLayerNumber - 0.1;			bounds: targetMorph boundsInWorld;			openInWorld: targetMorph world.	].	stageCompleted _ 0.	safetyFactor _ 1.1.	"better to guess high than low"	translucentMorph setProperty: #progressStageNumber toValue: 1.	translucentMorph hide.	targetOwner ifNotNil: [targetOwner hide].	totals _ self loadingHistoryDataForKey: 'total'.	newRatio _ 1.0.	estimate _ totals size < 2 ifTrue: [		15000		"be a pessimist"	] ifFalse: [		(totals sum - totals max) / (totals size - 1 max: 1) * safetyFactor.	].	start _ Time millisecondClockValue.	self forkProgressWatcher.	[		aBlock 			on: ProgressInitiationException			do: [ :ex | 				ex sendNotificationsTo: [ :min :max :curr |					"ignore this as it is inaccurate"				].			].	] on: ProgressNotification do: [ :note |		translucentMorph show.		targetOwner ifNotNil: [targetOwner show].		note extraParam ifNotNil:[self addProgressDecoration: note extraParam].		stageCompletedString _ (note messageText findTokens: ' ') first.		stageCompleted _ (stageCompletedString copyUpTo: $:) asNumber.		cumulativeStageTime _ Time millisecondClockValue - start max: 1.		prevData _ self loadingHistoryDataForKey: stageCompletedString.		prevData isEmpty ifFalse: [			newRatio _ (cumulativeStageTime / (prevData average max: 1)) asFloat.		].		self 			loadingHistoryAt: stageCompletedString 			add: cumulativeStageTime.		translucentMorph 			setProperty: #progressStageNumber 			toValue: stageCompleted + 1.		note resume.	].	stageCompleted _ 999.	"we may or may not get here"! !